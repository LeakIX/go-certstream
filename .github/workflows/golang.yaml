name: Go

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  release:
    types: [ created ]

env:
  PROJECT_NAME: certstream

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Get dependencies
        run: go mod download

      - name: Build Binaries
        env:
          CGO_ENABLED: 0
        run: |
          mkdir -p bin
          
          # Linux
          GOOS=linux GOARCH=386 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-linux-386 ./cmd/${PROJECT_NAME}
          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-linux-amd64 ./cmd/${PROJECT_NAME}
          GOOS=linux GOARCH=arm64 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-linux-arm64 ./cmd/${PROJECT_NAME}
          GOOS=linux GOARCH=arm GOARM=7 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-linux-arm7 ./cmd/${PROJECT_NAME}
          GOOS=linux GOARCH=arm GOARM=6 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-linux-arm6 ./cmd/${PROJECT_NAME}
          
          # MacOS (Darwin)
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-osx-amd64 ./cmd/${PROJECT_NAME}
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-osx-arm64 ./cmd/${PROJECT_NAME}
          
          # Windows
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-win64.exe ./cmd/${PROJECT_NAME}
          GOOS=windows GOARCH=386 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-win32.exe ./cmd/${PROJECT_NAME}
          
          # NetBSD
          GOOS=netbsd GOARCH=amd64 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-netbsd-amd64 ./cmd/${PROJECT_NAME}
          GOOS=netbsd GOARCH=386 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-netbsd-386 ./cmd/${PROJECT_NAME}
          GOOS=netbsd GOARCH=arm GOARM=6 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-netbsd-arm6 ./cmd/${PROJECT_NAME}
          GOOS=netbsd GOARCH=arm GOARM=7 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-netbsd-arm7 ./cmd/${PROJECT_NAME}
          GOOS=netbsd GOARCH=arm64 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-netbsd-arm64 ./cmd/${PROJECT_NAME}
          
          # OpenBSD
          GOOS=openbsd GOARCH=amd64 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-openbsd-64 ./cmd/${PROJECT_NAME}
          GOOS=openbsd GOARCH=386 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-openbsd-32  ./cmd/${PROJECT_NAME}
          GOOS=openbsd GOARCH=arm GOARM=6 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-openbsd-arm6 ./cmd/${PROJECT_NAME}
          GOOS=openbsd GOARCH=arm GOARM=7 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-openbsd-arm7 ./cmd/${PROJECT_NAME}
          GOOS=openbsd GOARCH=arm64 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-openbsd-arm64 ./cmd/${PROJECT_NAME}
          
          # FreeBSD
          GOOS=freebsd GOARCH=amd64 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-freebsd-amd64 ./cmd/${PROJECT_NAME}
          GOOS=freebsd GOARCH=386 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-freebsd-386 ./cmd/${PROJECT_NAME}
          GOOS=freebsd GOARCH=arm GOARM=6 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-freebsd-arm6 ./cmd/${PROJECT_NAME}
          GOOS=freebsd GOARCH=arm GOARM=7 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-freebsd-arm7 ./cmd/${PROJECT_NAME}
          GOOS=freebsd GOARCH=arm64 go build -ldflags="-s -w -extldflags '-static'" -o bin/${PROJECT_NAME}-freebsd-arm64 ./cmd/${PROJECT_NAME}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: bin/
          if-no-files-found: error

  release:
    name: Release
    needs: build
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: bin/

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: bin/*